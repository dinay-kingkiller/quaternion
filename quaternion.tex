\documentclass{amsart}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{xca}[theorem]{Exercise}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

\numberwithin{equation}{section}

\begin{document}

\title{Quaternion Rotation}

\begin{abstract}
Quaternions are almost magical with their ability to look like other concepts. They can be described by group/ring theory, or in terms of hyper-complex numbers, or in terms of vector spaces, and they can exist as all three of these at once. There are many resources on the algebra and analysis of quaternions, but often their definitions disagree, making it difficult to compare results. This paper hopes to formally define one type of quaternion operations and use those to derive final results. We will brush over proofs of generic quaternion algebra, and push through to applications ready for implementation in code. The language in this paper is more formal than other treatments, but often formal thinking is useful for defining your quaternion class in the programming language of choice.
\end{abstract}

\maketitle

\section{The Quaternion Ring}
%% A division ring has:
%% Addition is associative
%% addition identity
%% Addition inverse
%% Addition commutivity
%% Multiplication that is associative
%% Multiplication is associative over addition
%% Has an identity element
%% Every nonzero element has a multiplicative inverse.
\begin{definition}[Quaternion]
  Quaternions, hopefully obvious from their name, are ordered 4-tuples
  \begin{equation}
    \mathrm{q}=(x, y, z, w)\in\mathbb{H}\subset\mathbb{R}^4.
  \end{equation}
  The set of quaternions $\mathbb{H}$ form a division ring with two operations $\oplus$ and $\otimes$
\end{definition}
\begin{definition}[Quaternion Addition]
  Addition on quaternions is defined easily enough
  \begin{equation}
    \begin{pmatrix}
      x_1 \\
      y_1 \\
      z_1 \\
      w_1
    \end{pmatrix} \oplus
    \begin{pmatrix}
      x_2 \\
      y_2 \\
      z_2 \\
      w_2
    \end{pmatrix} =
    \begin{pmatrix}
      x_1 + x_2 \\
      y_1 + y_2 \\
      z_1 + z_2 \\
      w_1 + w_2
    \end{pmatrix}
  \end{equation}
\end{definition}
\begin{definition}[Quaternion Multiplication]
  However, multiplication is more complex
  \begin{equation} \label{eqn:multiplication}
    \begin{pmatrix}
      x_1 \\
      y_1 \\
      z_1 \\
      w_1
    \end{pmatrix} \otimes 
    \begin{pmatrix}
      x_2 \\
      y_2 \\
      z_2 \\
      w_2
    \end{pmatrix} =
% m_floats[3] * q.x() + m_floats[0] * q.m_floats[3] + m_floats[1] * q.z() - m_floats[2] * q.y(),
% m_floats[3] * q.y() + m_floats[1] * q.m_floats[3] + m_floats[2] * q.x() - m_floats[0] * q.z(),
% m_floats[3] * q.z() + m_floats[2] * q.m_floats[3] + m_floats[0] * q.y() - m_floats[1] * q.x(),
% m_floats[3] * q.m_floats[3] - m_floats[0] * q.x() - m_floats[1] * q.y() - m_floats[2] * q.z());
    \begin{pmatrix}
      w_1x_2 + x_1w_2 + y_1z_2 - z_1y_2 \\
      w_1y_2 - x_1z_2 + y_1w_2 + z_1x_2 \\
      w_1z_2 + x_1y_2 - y_1x_2 + z_1w_2 \\
      w_1w_2 - x_1x_2 - y_1y_2 - z_1z_2
    \end{pmatrix}
  \end{equation}
  But multiplication is what makes quaternions, quaternions. Other sources will often have a different definition of multiplication for quaternions that is incompatible with this one. All quaternion multiplication definitions should have similar properties, but when applying this to other topics, the definition of This formulation of multiplication was chosen to coincide with the ROS package \texttt{tf2}. A less formal re-creation of some of these definitions can be found in the next section.
\end{definition}

\begin{theorem}
  Quaternions form a commutative group with addition, which means they have the following properties
  \begin{itemize}
  \item Associativity: $\mathrm{q}_1\oplus(\mathrm{q}_2\oplus \mathrm{q}_3) = (\mathrm{q}_1\oplus \mathrm{q}_2) \oplus \mathrm{q}_3$
  \item Commutativity: $\mathrm{q}_1\oplus \mathrm{q}_2 = \mathrm{q}_2 \oplus \mathrm{q}_1$
  \item Identity: $\mathrm{q}\oplus \mathrm{e}_0=\mathrm{q}=\mathrm{e}_0\oplus \mathrm{q}$ where $\mathrm{e}_0$ is the 0-quaternion $(0, 0, 0, 0)$
  \item Inverse: $\mathrm{q}\oplus (-q)=\mathrm{q}\ominus \mathrm{q}=\mathrm{e}_0=(-\mathrm{q})\oplus \mathrm{q}$ where the inverse is defined $-\mathrm{q}=(-x, -y, -z, -w)$
  \end{itemize}
\end{theorem}

\begin{theorem}
  Unlike addition, quaternions for a \emph{non-commutative} group with multiplication, which gives them the following properties
  \begin{itemize}
  \item Associativity: $\mathrm{q}_1\otimes(\mathrm{q}_2\otimes \mathrm{q}_3) = (\mathrm{q}_1\otimes \mathrm{q}_2) \otimes \mathrm{q}_3$
  \item Identity: $\mathrm{q}\otimes\mathbf{1}=\mathrm{q}=\mathbf{1}\otimes \mathrm{q}$ where $\mathbf{1}$ is the identity quaternion $(0, 0, 0, 1)$
  \item Inverse: $\mathrm{q}\otimes \mathrm{q}^{-1}=\mathrm{q}/\mathrm{q}=\mathbf{1}=\mathrm{q}^{-1}\otimes \mathrm{q}$ unless $q$ is the zero quaternion.
  \end{itemize}
\end{theorem}

\begin{theorem}
  With the combination of operations, quaternions form a division ring, which adds distributive properties
  \begin{itemize}
  \item Left distributivity: $\mathrm{q}_1 \otimes \left(\mathrm{q}_2\oplus \mathrm{q}_3\right) = \left(\mathrm{q}_1\otimes \mathrm{q}_2\right) \oplus \left(\mathrm{q}_1\otimes \mathrm{q}_3\right)$
    \item Right distributivity: $\left(\mathrm{q}_1 \oplus \mathrm{q}_2\right) \otimes \mathrm{q}_3 = \left(\mathrm{q}_1\otimes \mathrm{q}_3\right) \oplus \left(\mathrm{q}_2 \otimes \mathrm{q}_3\right)$
  \end{itemize}
\end{theorem}

\begin{definition}
	\begin{equation}
		\mathrm{q}^* = 
		\begin{pmatrix}
			x \\
			y \\
			z \\
			w
		\end{pmatrix}^* =
		\begin{pmatrix}
			-x \\
			-y \\
			-z \\
			w
		\end{pmatrix}
	\end{equation}
\end{definition}


\begin{theorem}
	As a convolution algebra, quaternions have the following properties
	\begin{itemize}
	\item Conjugate Involution: $(\mathrm{q}^*)^*=\mathrm{q}$
	\item $\|\mathrm{q}_1\otimes \mathrm{q}_2\| = \|\mathrm{q}_1\|\|\mathrm{q}_2\|$
	\end{itemize}
\end{theorem}


\section{Scalar Quaternions}
This section is overly formal and could probably be left out, still...with our strict rules of quaternions, we will force the subject
\begin{definition}[Quaternion Scalars]
  Multiplication between scalars and quaternions is defined in terms of quaternion multiplication. For a scalar $s\in\mathbb{R}$
  \begin{equation}
    s
    \begin{pmatrix}
      x \\
      y \\
      z \\
      w
    \end{pmatrix} =
    \begin{pmatrix}
      0 \\
      0 \\
      0 \\
      s \\
    \end{pmatrix}
    \otimes 
    \begin{pmatrix}
      x \\
      y \\
      z \\
      w
    \end{pmatrix} = 
    \begin{pmatrix}
      sx \\
      sy \\
      sz \\
      sw
    \end{pmatrix}
  \end{equation}
  For good measure, lets define addition of a scalar $s\in\mathbb{R}$ and a quaternion $q\in\mathbb{H}$ similarily
  \begin{equation}
    s+
    \begin{pmatrix}
      x \\
      y \\
      z \\
      w
    \end{pmatrix} =
    \begin{pmatrix}
      0 \\
      0 \\
      0 \\
      s \\
    \end{pmatrix}
    \oplus
    \begin{pmatrix}
      x \\
      y \\
      z \\
      w
    \end{pmatrix} = 
    \begin{pmatrix}
      x \\
      y \\
      z \\
      s + w
    \end{pmatrix}
  \end{equation}
  With those two definitions, scalars can be readily transformed back and forth between \emph{scalar quaternions}: quaternions of the form $(0, 0, 0, s)$. The algebraic properties of the real field $\left(\mathbb{R}, +, \times\right)$ and the quaternion ring $\mathbb{H}, \oplus, \otimes$ behave similiarly enough, that from here on, we will use the notation for the real field: $+$ and $\times$. 
\end{definition}

\section{The Quaternion Space}
%% Vector space:
%% Associativity of vector addition
%% Commutativity of vector addition
%% Vector addition identity
%% Vector inverse identity
%% Scaling Associativity a(bv) = (ab)v
%% Scaling identity
%% Distributivity of scalar over addition
%% Distributivity of addition over scaling

\begin{theorem}
  Quaternions form a vector space with the real field, which means they have the following properties 
  \begin{itemize}
  \item $(\mathbb{H}, \oplus)$ forms a commutative group. Details above.
  \item Compatibility: $s_1(s_2q) = (s_1s_2)q$
  \item Scalar Identity: $1q = q$ where $1\in\mathbb{R}$
  \item Distributivity over quaternion addition: $s(q_1+ q_2) = sq_1 + sq_2$
  \item Distributivity over scalar multiplication: $(s_1+ s_2) q = s_1q + s_2 q$
  \end{itemize}
\end{theorem}

\begin{definition}
  In the quaternion vector space we can define four orthogonal unit bases:
  \begin{equation}
    \mathbf{i} =
    \begin{pmatrix}
      1 \\
      0 \\
      0 \\
      0
    \end{pmatrix},
    \mathbf{j} =
    \begin{pmatrix}
      0 \\
      1 \\
      0 \\
      0
    \end{pmatrix}, 
    \mathbf{k} =
    \begin{pmatrix}
      0 \\
      0 \\
      1 \\
      0
    \end{pmatrix}, 
    \mathbf{1} =
    \begin{pmatrix}
      0 \\
      0 \\
      0 \\
      1
    \end{pmatrix}
  \end{equation}
  Each quaternion can now be written out $q = x \mathbf{i} + y \mathbf{j} + z \mathbf{z} + w$. The $\mathbf{1}$ is the unit quaternion and can be dropped after our previous formalizations of scalar/quaternion addition. Since we previously defined the addition of a scalar with a quaternion the $\mathbf{1}$ can also be dropped, i.e. $w+\mathrm{q} = w\mathbf{1} +\mathrm{q}$ for all scalars $w\in\mathbb{R}$
\end{definition}

\begin{theorem}
  The definition of quaternion multiplication in equation \ref{eqn:multiplication} is unintuitive and hard to remember. Historically quaternions were used to extend complex numbers and as such, using the bases definition above, the complex $i^2=-1$ can be extended for quaternion hypercomplex numbers
  \begin{equation}
    \mathbf{ii} = \mathbf{jj} = \mathbf{kk} = \mathbf{ijk} = -\mathbf{1}
  \end{equation}
  Please note, some papers do not use this definition and therefor have a different definition of quaternions. The math can all work out the same at the end, but be wary swapping between papers could mean a missed sign or swapped commutativity.
\end{theorem}

\section{Vector Quaternions}
In the previous section we said quaternions form a vector space, so technically every quaternion is a 4-vector. But in practice, quaternions are lovely because of how they work alongside 3-vectors.
\begin{definition}[Vector Quaternion]
  Quaternions behave like vectors with scalars attached. More formally, every quaternion can be described by a \emph{vector} or \emph{pure quaternion} $\mathbf{v}=\left(x, y, z, 0\right)$ plus a scalar quaternion $s=\left(0,0,0,s\right)$: either $s+\mathbf{v}$ or, like below, $(\mathbf{v}, s)$. Addition is then just:
  \begin{equation}
    \begin{pmatrix}
      \mathbf{v}_1 \\
      s_1
    \end{pmatrix}
    +
    \begin{pmatrix}
      \mathbf{v}_2 \\
      s_2
    \end{pmatrix}
    =
    \begin{pmatrix}
      p_0+q_0 \\
      \mathbf{p} + \mathbf{q}
    \end{pmatrix}
  \end{equation}
  and multiplication can be defined from the vector dot and cross product
  \begin{equation}
    \begin{pmatrix}
      \mathbf{v}_1 \\
      s_1
    \end{pmatrix}
    \otimes
    \begin{pmatrix}
      \mathbf{v}_2 \\
      s_2
    \end{pmatrix}
    =
    \begin{pmatrix}
      s_1\mathbf{v}_2 + s_2\mathbf{v}_1 + \mathbf{v}_1\times \mathbf{v}_2 \\
      s_1s_2 - \mathbf{v}_1\cdot \mathbf{v}_2
    \end{pmatrix}
  \end{equation}
  For pure quaternions, that final equation becomes
  \begin{equation}
    \mathbf{v}_1\otimes\mathbf{v}_2 =
    \begin{pmatrix}
      -\mathbf{v}_1\cdot \mathbf{v}_2\\
      \mathbf{v}_1 \times \mathbf{v}_2
    \end{pmatrix}
  \end{equation}
  The scalar part is minus the dot product of the two vectors and the vector part is the cross product--another way to re-derive equation \ref{eqn:multiplication} from a more readable/memorable place.\end{definition}

\begin{theorem}[Quaternion Commutor]
  Quaternion multiplication is not commutative.
\end{theorem}
\begin{proof}
  Let $q_1$ and $q_2$ be any two quaternions. In terms of vectors, their commutor would be
  \begin{equation}
    q_1\otimes q_2-q_2\otimes q_1
    =
    \begin{pmatrix}
      v_1 \times v_2 - v_2 \times v_1 \\
      -v_1\cdot v_2 +v_2\cdot v_1
    \end{pmatrix}
  \end{equation}
  The vector dot product is commutative $v_1\cdot v_2 = v_2\cdot v_1$, but the vector cross product is \emph{anti-}commutative $v_1\times v_2 = -v_2 \times v_1$. Thus
  \begin{equation}
    q_1\otimes q_2-q_2\otimes q_1 =
    \begin{pmatrix}
      2v_1\times v_2
    \end{pmatrix}
  \end{equation}
  If we allow $q_1\cdot q_2$ and $q_1\times q_2$ be the dot and cross product on their \emph{vector} component, respectively, then the commuter is simply: $2q_1\times q_2$
\end{proof}


\section{Rotation Group}
% Closure
% Associativity
% Identity
% Inverse

\begin{theorem}
  Quaternions with norm $\|q\|=1$ form a subgroup of the quaternion product.
	\begin{itemize}
		\item Closure: If $\|\mathrm{q}_1\|=1$ and $\|\mathrm{q}_2\|=1$ then $\|\mathrm{q}_1\mathrm{q}_2\|$
		\item Identity: The identity quaternion is a versor $\|\mathbf{1}\|=1$
		\item Inverse: If 
	\end{itemize}
\end{theorem}

\begin{theorem}
  The norm of the product of two quaternions is equal to the product of the norm of the two quaterions. So, if the two versors have norm equal to one, the norm of their product must be one. Which makes the resultant quaternion a versor.
\end{theorem}

\begin{theorem}
  The identity quaternion $(1, 0, 0, 0)$ belongs to the versor subgroup.
\end{theorem}

\begin{theorem}
  The inverse of every versor is a versor. As well, the inverse is equal to the conjugate.
\end{theorem}

\begin{definition}
  Quaternions can be used to describe rotations in space. A versor rotates between reference frames ${^\mathrm{A}q^\mathrm{B}}:\mathrm{A}\to\mathrm{B}$. Without describing $\mathbf{v}\in\mathbb{R}^3$ in either $\mathrm{A}$ or $\mathrm{B}$ basis:
  \begin{equation}
    \begin{pmatrix}
      \mathbf{v} \cdot \hat{\mathbf{b}}_x \\
      \mathbf{v} \cdot \hat{\mathbf{b}}_y \\
      \mathbf{v} \cdot \hat{\mathbf{b}}_z
    \end{pmatrix} = {^\mathrm{B}q^\mathrm{A}} \otimes 
    \begin{pmatrix}
      \mathbf{v} \cdot \hat{\mathbf{a}}_x \\
      \mathbf{v} \cdot \hat{\mathbf{a}}_y \\
      \mathbf{v} \cdot \hat{\mathbf{a}}_z
    \end{pmatrix} \otimes {^\mathrm{B}q^{*\mathrm{A}}}
  \end{equation}
\end{definition}

\begin{theorem}
  The \emph{unit quaternion} $\mathbf{1}$ is the rotation identity
  \begin{equation}
   \mathbf{1} \mathbf{v} \mathbf{1}^* = \mathbf{v}  
  \end{equation} 
\end{theorem}

\begin{theorem}
  By pre- and post-multiplying quaternion conjugates to invert the rotation
  \begin{equation}
    {\mathrm{q}_{A2B}^*}\left({^B\mathbf{v}}\right)\left(\mathrm{q}_{A2B}\right)={^A\mathbf{v}}
  \end{equation}
  we see that the inverse of the rotation is just its conjugate. When there is just one rotation, the rotation will be denoted as $q$ and its inverse $q^*$.
\end{theorem}

\section{Quaternion Transforms}
% Closure
% Associative
% Identity
% Inverse
% SO(3) equivalence



\begin{theorem}[Quaternion to Matrix]
  Every rotation $\mathrm{A}\to\mathrm{B}$ can be described as both a quaternion and a rotation matrix
  \begin{equation}
    \left({^\mathrm{B}q^\mathrm{A}}\right) \otimes {^\mathrm{A}\mathbf{v}} \otimes \left({^\mathrm{A}q^\mathrm{B}}\right) = \left({^\mathrm{B}R^\mathrm{A}}\right){^A\mathrm{A}\mathbf{v}}
  \end{equation}
  that rotation matrix also collects the dot products of the rotation.
  
  \begin{tabular}{c|ccc}
    ${^BR^A}$ & $\hat{\mathbf{a}}_x$ & $\hat{\mathbf{a}}_y$ & $\hat{\mathbf{a}}_z$ \\
    \hline
    $\hat{\mathbf{b}}_x$ & $q_0^2+q_1^2-q_2^2-q_3^2$ & $-2q_0q_3+2q_1q_2$ & $2q_0q_2 + 2q_1q_3$ \\
    $\hat{\mathbf{b}}_y$ & $2q_0q_3+2q_1q_2$ & $q_0^2-q_1^2+q_2^2-q_3^2$ &  $-2q_0q_1 + 2q_2q_3$ \\
    $\hat{\mathbf{b}}_z$ & $-2q_0q_2+2q_1q_3$ & $2q_0q_1+2q_2q_3$ & $q_0^2-q_1^2-q_2^2+q_3^2$
  \end{tabular}\centering
\end{theorem}
\begin{proof}
  $R$ can be formed from algebra. The notation used implies that a pure quaternion is equal to its vector part.
  \begin{eqnarray}
    R \mathbf{v} &=&
    \begin{pmatrix}
      x \\
      y \\
      z \\
      w
    \end{pmatrix} \otimes
    \mathbf{v} \otimes
    \begin{pmatrix}
      -x \\
      -y \\
      -z \\
      w
    \end{pmatrix} \nonumber \\
    R &=&
    \begin{pmatrix}
      x^2-y^2-z^2+w^2 & 2xy-2zw & 2xz+2yw \\
      2xy+2zw & -x^2+y^2-z^2+w^2 & -2xw+2yz \\
      2xz-2wy & 2xw+2yz & -x^2-y^2+z^2+w^2
    \end{pmatrix}
  \end{eqnarray} 
\end{proof}

\section{Smooth Transforms}
\begin{theorem}
  The quaternion is related to angular velocity by the following formula
  \begin{equation}
    \dot{q} = \frac{1}{2} q \otimes \boldsymbol\omega
  \end{equation}
\end{theorem}
\begin{proof}
  Start with the equation from 2-point theory, which says, for a vector $\mathbf{v}$, described in $\mathrm{A}$ (as ${^A\mathbf{v}}$) and in $\mathrm{B}$ (as ${^B\mathbf{v}}$):
  \begin{equation}
    \frac{d}{dt} {^\mathrm{B}\mathbf{v}} = \frac{d}{dt} {^\mathrm{A}\mathbf{v}} + {^\mathrm{B}\boldsymbol\omega^\mathrm{A}} \times {^\mathrm{A}\mathbf{v}}
  \end{equation}
  Strategically substituting our rotation quaternion
  \begin{equation}
    \frac{d}{dt} \left[\left({^\mathrm{B}q^\mathrm{A}}\right)\left({^A\mathbf{v}}\right)\left({^\mathrm{A}q^\mathrm{B}}\right) \right]  = \frac{d}{dt} {^\mathrm{A}\mathbf{v}} + {^\mathrm{B}\boldsymbol\omega^\mathrm{A}}\times {^\mathrm{A}\mathbf{v}}
  \end{equation}
  After this, we'll drop the $A$/$B$ bases for clarity. Choose a vector $\mathbf{v}$ in $\mathrm{A}$ where $\mathbf{v}$ is fixed, then:
  \begin{equation}
    \dot{q}\mathbf{v}q^*+q\mathbf{v}\dot{q}^* = \boldsymbol\omega\times \mathbf{v}
  \end{equation}
  Manipulating the left hand side with identities
  \begin{eqnarray}
    q^*\dot{q}\mathbf{v}q^*\dot{q}+q^*q\mathbf{v}\dot{q}^*\dot{q} &=& q^*\left(\boldsymbol\omega\times\mathbf{v}\right)\dot{q}\nonumber \\
    q^*\dot{q}\mathbf{v}q^*\dot{q}+\mathbf{v} &=& q^*\left(\boldsymbol\omega\times\mathbf{v}\right)\dot{q}\nonumber \\
  \end{eqnarray}
\end{proof}

Linear interpolation
\begin{equation}
  q_{k+1} = \frac{1}{2}q_k\boldsymbol\omega\Delta t + q_k 
\end{equation}

Spherical interpolation?
\begin{equation}
  q_{k+1} = \exp\left(\frac{1}{2} \boldsymbol\omega\Delta t\right)q_k
\end{equation}





\end{document}

%-----------------------------------------------------------------------
% End of quaternion.tex
%-----------------------------------------------------------------------
